with Ada.Strings.Maps;
with Ada.Exceptions;
with Ada.Text_IO;
with Ada.Streams.Stream_IO.;
with httpaux; use httpaux;
with Petition_Analysis;

package body http10 is

   package SIO renames Ada.Streams.Stream_Io;

   procedure Attend_Petition(Peticion: in Petition_Type; Conexion: in out aliased TCP.Connection) is

   begin

      --De momento solo contempla los metos Get y Head
      if Peticion.Method= Petition_Analysis.GET then
         Attend_GET_Petition();
      elsif Peticion.Method= Petition_Analysis.HEAD then
         Attend_HEAD_Petition();
      else
         String'Write(Serv_Conn'access, cABECERA501);
      end if;

   end Attend_Petition;


   procedure Attend_GET_Petition(Peticion: in Petition_Type; Conexion: in out aliased TCP.Connection) is
      fichero: Ada.Streams.Stream_IO.File_Type;
      Acceso_Fichero:   Ada.Streams.Stream_IO.Stream_Access;
      car_Leido:char;
      cadena_leida:ASU.Unbounded_string;
   begin

      --Comprobacion del dominio (de momento sin acceso a ficheros)
      if ASU.To_String(Peticion.URI.Host)="www.localdomain.com"
or CoincideCampo(peticion,ASU.To_Unbounded_String("Host"), ASU.To_Unbounded_String("www.localdomain.com")) then
         begin

            SIO.Open(Fichero, SIO.In_File, "/webdocs" & ASU.To_String(Peticion.uri.Path));
            --Calculamos su tamaño, y preparamos la cabecera
            TamFichero := NATURAL(SIO.Size(MiFichero));
            String'Write(conexion'Access, CABECERA200);
            String'Write(conexion'access,"Content-Length: "& tamFichero'image & End_of_Header);
            --Accedemos al fichero
            Acceso_Fichero := SIO.Stream(Fichero);
            --Lectura y escritura(envio) del fichero..
            while not SIO.End_Of_File(archivo) loop
               char'Read(acceso_fichero,car_leido);
               cadenaLeida:=cadenaLeida + Car_Leido;
            end loop;

            String'write(conexion'access, ASU.to_string(cadenaLeida));

         exception
            when SIO.Name_Error =>

               -- DEVOLVER MENSAJE 404
               String'Write(Serv_Conn'access,CABECERA404);
         end;
      end if;

      else
         --DEVOLVER MENSAJE DE BAD REQUEST
         String'Write(Serv_Conn'access, CABECERA400);

      end if;

   end Attend_GET_Petition;

end http10;
